# LowerCode Go Server

<div align="center">

ä½ä»£ç ç¼–è¾‘å™¨çš„ Go åç«¯æœåŠ¡ï¼Œæ”¯æŒ **å®æ—¶ååŒç¼–è¾‘** å’Œ **ä¸€é”®å‘å¸ƒ**ã€‚

[![Go Version](https://img.shields.io/badge/Go-1.23+-00ADD8?logo=go)](https://go.dev)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

</div>

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ”„ **å®æ—¶ååŒç¼–è¾‘** - åŸºäº WebSocket + JSON Patch çš„å¤šäººå®æ—¶ç¼–è¾‘
- ğŸ” **Clerk è®¤è¯** - å¼€ç®±å³ç”¨çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- ğŸ“¦ **PostgreSQL æŒä¹…åŒ–** - ä½¿ç”¨ GORM ç®¡ç†é¡µé¢æ•°æ®
- ğŸ—ï¸ **æ¸…æ™°çš„åˆ†å±‚æ¶æ„** - Controller â†’ UseCase â†’ Repository
- âš¡ **ä¼˜é›…åœæœº** - ç¡®ä¿ç¼–è¾‘çŠ¶æ€è½ç›˜ï¼Œæ•°æ®ä¸ä¸¢å¤±

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
lowercode-go-server/
â”œâ”€â”€ cmd/                    # åº”ç”¨å…¥å£
â”‚   â””â”€â”€ main.go             # ä¸»å‡½æ•° + ä¼˜é›…åœæœº
â”‚
â”œâ”€â”€ api/                    # API å±‚ (æ¥æ”¶è¯·æ±‚)
â”‚   â”œâ”€â”€ controller/         # æ§åˆ¶å™¨ (å¤„ç† HTTP/WS è¯·æ±‚)
â”‚   â”‚   â”œâ”€â”€ page_controller.go    # é¡µé¢ CRUD API
â”‚   â”‚   â”œâ”€â”€ ws_handler.go         # WebSocket å…¥å£
â”‚   â”‚   â””â”€â”€ webhook_controller.go # Clerk Webhook
â”‚   â”œâ”€â”€ route/              # è·¯ç”±é…ç½®
â”‚   â””â”€â”€ middleware/         # ä¸­é—´ä»¶ (Clerk é‰´æƒ)
â”‚
â”œâ”€â”€ bootstrap/              # å¯åŠ¨é…ç½®
â”‚   â”œâ”€â”€ app.go              # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ database.go         # PostgreSQL è¿æ¥
â”‚   â””â”€â”€ env.go              # ç¯å¢ƒå˜é‡
â”‚
â”œâ”€â”€ domain/                 # é¢†åŸŸå±‚ (æ ¸å¿ƒå®šä¹‰)
â”‚   â”œâ”€â”€ entity/             # å®ä½“ (Page, User)
â”‚   â”œâ”€â”€ repository/         # Repository æ¥å£
â”‚   â””â”€â”€ errors/             # ä¸šåŠ¡é”™è¯¯å®šä¹‰
â”‚
â”œâ”€â”€ usecase/                # ç”¨ä¾‹å±‚ (ä¸šåŠ¡é€»è¾‘)
â”‚   â””â”€â”€ page_usecase.go     # é¡µé¢ä¸šåŠ¡ + Hub åè°ƒ
â”‚
â”œâ”€â”€ repository/             # Repository å®ç°
â”‚   â””â”€â”€ page_repository.go  # GORM å®ç°
â”‚
â”œâ”€â”€ internal/ws/            # WebSocket ååŒæœåŠ¡
â”‚   â”œâ”€â”€ hub.go              # æˆ¿é—´ç®¡ç†å™¨ (Actor Model)
â”‚   â”œâ”€â”€ room.go             # å•ä¸ªåä½œæˆ¿é—´
â”‚   â”œâ”€â”€ client.go           # å®¢æˆ·ç«¯è¿æ¥
â”‚   â””â”€â”€ message.go          # æ¶ˆæ¯åè®®
â”‚
â””â”€â”€ docs/                   # å¼€å‘æ–‡æ¡£
```

---

## ğŸ›ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚èŒè´£

| å±‚                 | èŒè´£                        | ä¾èµ–æ–¹å‘             |
| :----------------- | :-------------------------- | :------------------- |
| **api/controller** | æ¥æ”¶ HTTP/WS è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒ | â†’ usecase            |
| **usecase**        | ä¸šåŠ¡é€»è¾‘ç¼–æ’                | â†’ domain, repository |
| **repository**     | æ•°æ®åº“ CRUD (GORM å®ç°)     | â†’ domain             |
| **domain**         | æ ¸å¿ƒå®ä½“ã€æ¥å£ã€é”™è¯¯å®šä¹‰    | æ— ä¾èµ–               |
| **internal/ws**    | WebSocket å®æ—¶ååŒæœåŠ¡      | â†’ usecase            |

### WebSocket ååŒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Hub (æˆ¿é—´ç®¡ç†å™¨)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ rooms: map[pageId]*Room                              â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚ â”‚ Room: page1 â”‚  â”‚ Room: page2 â”‚  â”‚ Room: page3 â”‚    â”‚   â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚   â”‚
â”‚  â”‚ â”‚ â”‚Client A â”‚ â”‚  â”‚ â”‚Client C â”‚ â”‚  â”‚ â”‚Client E â”‚ â”‚    â”‚   â”‚
â”‚  â”‚ â”‚ â”‚Client B â”‚ â”‚  â”‚ â”‚Client D â”‚ â”‚  â”‚ â”‚         â”‚ â”‚    â”‚   â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Go 1.23+
- PostgreSQL (æ¨èä½¿ç”¨ Supabase)
- Clerk è´¦å· (ç”¨äºè®¤è¯)

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/your-org/lowercode-go-server.git
cd lowercode-go-server
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.exmple .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“è¿æ¥
DATABASE_URL="postgresql://user:password@host:5432/dbname"

# æœåŠ¡ç«¯å£
PORT=8080

# Clerk è®¤è¯
CLERK_SECRET_KEY=sk_test_xxx
CLERK_WEBHOOK_SECRET=whsec_xxx
```

### 3. å®‰è£…ä¾èµ– & å¯åŠ¨

```bash
# å®‰è£…ä¾èµ–
go mod tidy

# å¯åŠ¨æœåŠ¡
go run cmd/main.go
```

æœåŠ¡å°†åœ¨ `http://localhost:8080` å¯åŠ¨ã€‚

### 4. éªŒè¯æœåŠ¡

```bash
curl http://localhost:8080/health
# è¿”å›: {"service":"lowcode-go-server","status":"ok"}
```

---

## ğŸ“¡ API ç«¯ç‚¹

| ç«¯ç‚¹                 | æ–¹æ³•      | è¯´æ˜       | è®¤è¯            |
| :------------------- | :-------- | :--------- | :-------------- |
| `/health`            | GET       | å¥åº·æ£€æŸ¥   | âŒ              |
| `/api/pages/:pageId` | GET       | è·å–é¡µé¢   | âœ… Bearer Token |
| `/api/pages`         | POST      | åˆ›å»ºé¡µé¢   | âœ… Bearer Token |
| `/api/pages/:pageId` | DELETE    | åˆ é™¤é¡µé¢   | âœ… Bearer Token |
| `/ws`                | WebSocket | ååŒç¼–è¾‘   | âœ… URL Token    |
| `/webhook/clerk`     | POST      | Clerk å›è°ƒ | âœ… ç­¾åéªŒè¯     |

> è¯¦ç»†çš„ API æ–‡æ¡£è¯·æŸ¥çœ‹ [å‰ç«¯å¯¹æ¥æŒ‡å—](docs/frontend-integration.md)

---

## ğŸ”Œ WebSocket åè®®

### è¿æ¥æ–¹å¼

```
wss://your-domain/ws?pageId=xxx&token=<jwt_token>
```

### æ¶ˆæ¯ç±»å‹

| ç±»å‹          | æ–¹å‘            | è¯´æ˜                        |
| :------------ | :-------------- | :-------------------------- |
| `sync`        | Server â†’ Client | å…¨é‡çŠ¶æ€åŒæ­¥ (æ–°ç”¨æˆ·åŠ å…¥æ—¶) |
| `op-patch`    | åŒå‘            | JSON Patch å¢é‡ç¼–è¾‘         |
| `cursor-move` | åŒå‘            | å…‰æ ‡ä½ç½®åŒæ­¥                |
| `user-join`   | Server â†’ Client | ç”¨æˆ·åŠ å…¥é€šçŸ¥                |
| `user-leave`  | Server â†’ Client | ç”¨æˆ·ç¦»å¼€é€šçŸ¥                |
| `error`       | Server â†’ Client | é”™è¯¯æ¶ˆæ¯                    |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£                                         | è¯´æ˜                                  |
| :------------------------------------------- | :------------------------------------ |
| [å‰ç«¯å¯¹æ¥æŒ‡å—](docs/frontend-integration.md) | REST APIã€WebSocketã€è®¤è¯é›†æˆè¯¦ç»†è¯´æ˜ |
| [åç«¯è®¾è®¡æŒ‡å—](docs/go-backend-guide.md)     | æ¶æ„è®¾è®¡ã€æ•°æ®æµã€æ‰©å±•ç­–ç•¥            |
| [æµ‹è¯•æŒ‡å—](docs/testing.md)                  | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•è¯´æ˜                |

---

## ğŸ› ï¸ å¼€å‘

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œå¸¦è¦†ç›–ç‡
go test -cover ./...

# è¿è¡Œç‰¹å®šåŒ…çš„æµ‹è¯•
go test ./internal/ws/...
```

### ä»£ç è§„èŒƒ

```bash
# æ ¼å¼åŒ–ä»£ç 
go fmt ./...

# é™æ€æ£€æŸ¥
go vet ./...
```

---

## ğŸ“„ License

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶
